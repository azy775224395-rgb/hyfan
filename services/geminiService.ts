
import { GoogleGenAI } from "@google/genai";

export class GeminiService {
  private getClient() {
    const apiKey = process.env.API_KEY;
    if (!apiKey) throw new Error("API Key is missing");
    return new GoogleGenAI({ apiKey });
  }

  async chatWithCustomer(message: string, context: string): Promise<string> {
    try {
      const ai = this.getClient();
      const response = await ai.models.generateContent({
        model: 'gemini-3-flash-preview',
        contents: [{ role: 'user', parts: [{ text: message }] }],
        config: {
          systemInstruction: `أنت "خبير مبيعات ومستشار طاقة" رسمي لمتجر "حيفان للطاقة المتجددة". لست برنامجاً، بل موظف مبيعات محترف ومباشر.

المحظورات القطعية (يمنع استخدامها تماماً):
- "لا أستطيع"، "ليس لدي معلومات"، "مشغول"، "ضغط"، "مشكلة اتصال"، "لاحقاً"، "اعتذر"، "خطأ".

قواعد الرد المهنية:
1. الثقة والوضوح: تحدث كخبير يمتلك الحل دائماً. إجابتك يجب أن تكون مبنية على "بيانات المتجر" الموفرة لك فقط.
2. التعامل مع توفر المنتجات:
   - إذا سُئلت عن منتج موجود: قل "نعم، المنتج متوفر فوراً. [اسم المنتج] بسعر [السعر] ر.س. يتميز بـ [ذكر ميزة]. يمكنك طلبه من هنا: [رابط المنتج]."
   - إذا سُئلت عن منتج غير موجود أو ماركة أخرى: قل "حالياً نوفر بدائل أفضل تقنياً من طلبك، أقترح عليك [اسم منتج بديل من نفس الفئة] بسعر [السعر] ر.س. يمكنك طلبه من الرابط: [رابط المنتج البديل]."
3. الروابط: يجب دائماً تزويد العميل برابط المنتج. الرابط هو: ${window.location.origin}/#product-[ID] (استبدل [ID] بمعرف المنتج).
4. المجال: أنت خبير في (الألواح، البطاريات، الإنفرترات، المنظومات المنزلية، الأجهزة الموفرة).
5. خارج المجال: إذا كان السؤال خارج الطاقة أو المبيعات، قل "يسعدني خدمتك في كل ما يخص حلول الطاقة ومنتجاتنا، تفضل بسؤالك عن المنظومات أو الأجهزة المتوفرة."
6. أسلوب البيع: شجع العميل على اتخاذ قرار الشراء فوراً عبر ذكر ميزة تقنية قوية أو السعر المنافس.

بيانات المتجر الحصرية:
${context}

تحدث بالعربية الفصحى البسيطة بلهجة واثقة ومحترمة. ابدأ الرد مباشرة دون مقدمات طويلة.`,
          temperature: 0.2,
        }
      });
      
      return response.text?.trim() || "أهلاً بك. أنا مستشارك في حيفان للطاقة، تفضل بسؤالك عن الألواح أو البطاريات وسأعطيك الحل الأمثل فوراً.";
    } catch (e) {
      console.error("Gemini Error:", e);
      // رد بديل مبيعاتي واثق حتى عند حدوث خطأ
      return "أهلاً بك في حيفان. كخبير طاقة، أنصحك بالاطلاع على ألواح جينكو 580 وات وبطاريات توبو المتوفرة لدينا حالياً بأسعار منافسة. ما هي احتياجات منزلك من الطاقة اليوم؟";
    }
  }
}

export const geminiService = new GeminiService();
