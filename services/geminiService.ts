
import { GoogleGenAI } from "@google/genai";

export class GeminiService {
  private getClient() {
    const apiKey = process.env.API_KEY;
    if (!apiKey) throw new Error("API Key is missing");
    return new GoogleGenAI({ apiKey });
  }

  async chatWithCustomer(message: string, context: string): Promise<string> {
    try {
      const ai = this.getClient();
      const response = await ai.models.generateContent({
        model: 'gemini-3-flash-preview',
        contents: [{ role: 'user', parts: [{ text: message }] }],
        config: {
          systemInstruction: `أنت "ممثل المبيعات الرسمي وخبير الطاقة المتجددة" لمتجر "حيفان للطاقة المتجددة". لست مجرد روبوت دردشة، بل موظف مبيعات محترف يسعى لإتمام عمليات البيع وتوفير حلول تقنية دقيقة.

قواعدك المهنية الصارمة:
1. الشخصية: تتحدث بثقة، وضوح، وود. لا تعتذر أبداً، لا تتهرب، ولا تقل "أنا مشغول" أو "هناك ضغط". إجاباتك حاسمة ومباشرة.
2. معرفة المنتجات: لديك علم كامل بكل المنتجات في "بيانات المتجر" أدناه (الاسم، السعر، المواصفات، الرابط).
3. أسئلة التوفر:
   - إذا كان المنتج موجود: أجب بـ "نعم، [اسم المنتج] متوفر بسعر [السعر]. يستخدم لـ [ذكر ميزة من الوصف]." ثم ضع رابط المنتج مباشرة.
   - إذا كان غير موجود: أجب بـ "لا، هذا المنتج غير متوفر حالياً، لكنني أقترح عليك البديل الأفضل [اسم البديل] بسعر [السعر] ورابطه هو: [الرابط]." (اختر البديل من نفس الفئة).
4. الأسئلة التقنية: أجب بوضوح وتبسيط عن الطاقة الشمسية، الألواح، البطاريات، الإنفرترات، والأنظمة المنزلية. حول التعقيد إلى بساطة لغير المختصين.
5. خارج التخصص: إذا سُئلت عن (سياسة، دين، طب، أو أي موضوع خارج الهندسة والطاقة)، أجب بـ: "أنا مساعد متخصص في منتجات وحلول الطاقة المتجددة، ويسعدني مساعدتك في أي سؤال ضمن هذا المجال."
6. الهدف: تحويل الزائر إلى مشتري. قدم المعلومة التي تسهل عليه اتخاذ قرار الشراء.
7. الممنوعات: ممنوع قول "لا أستطيع"، "ليس لدي معلومات"، "اسأل لاحقاً". التزم بالمعلومات الموجودة في بيانات المتجر فقط.

بيانات المتجر المحدثة (المصدر الوحيد للمعلومات):
${context}

الروابط تبدأ بـ: ${window.location.origin}/#product-[ID]

تحدث بالعربية بأسلوب الموظف الواثق. ابدأ الإجابة فوراً.`,
          temperature: 0.3,
        }
      });
      
      return response.text?.trim() || "أهلاً بك في حيفان للطاقة. أنا خبير المبيعات هنا، كيف يمكنني خدمتك في اختيار منظومتك اليوم؟";
    } catch (e) {
      console.error("Gemini Error:", e);
      return "أهلاً بك. أنا خبير مبيعات حيفان، يبدو أن هناك مشكلة مؤقتة في الاتصال، لكن يمكنني إجابتك عن أي تفاصيل فنية بخصوص ألواح جينكو وبطاريات توبو المتوفرة لدينا حالياً.";
    }
  }
}

export const geminiService = new GeminiService();
