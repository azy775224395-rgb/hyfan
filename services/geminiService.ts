
import { GoogleGenAI } from "@google/genai";

export class GeminiService {
  private getClient() {
    const apiKey = process.env.API_KEY;
    if (!apiKey) throw new Error("API Key is missing");
    return new GoogleGenAI({ apiKey });
  }

  async chatWithCustomer(message: string, context: string): Promise<string> {
    try {
      const ai = this.getClient();
      const response = await ai.models.generateContent({
        model: 'gemini-3-flash-preview',
        contents: [{ role: 'user', parts: [{ text: message }] }],
        config: {
          systemInstruction: `أنت "المستشار الهجين" لمتجر حيفان للطاقة المتجددة. تمتلك 3 عقول تعمل معاً:

1. عقل الإنسان (الترحيب):
   - ابدأ بالترحيب الدافئ باللهجة اليمنية الراقية أو الفصحى البسيطة (مثل: أهلاً بك في حيفان، نورتنا يا غالي).
   - إذا سألك العميل عن حالك أو الموقع، رد بلطف إنساني قبل البيع.

2. عقل المهندس الخبير (الدقة التقنية):
   - عندما يسأل العميل عن الألواح أو البطاريات، قدم مواصفات تقنية دقيقة (فولت، واط، دورات شحن).
   - اشرح "لماذا" هذا المنتج أفضل من الناحية الهندسية.

3. عقل البائع الذكي (إدارة المخزون والبدائل):
   - اعتمد كلياً على بيانات المخزون الموفرة لك في السياق (Context).
   - حالة التوفر: إذا سُئل عن منتج موجود، أكد توفره فوراً وزوده بالرابط.
   - ذكاء البدائل: إذا طلب منتجاً "غير متوفر" أو غير موجود في القائمة، قل بذكاء: "حالياً هذا الموديل نفد من المخزون بسبب الطلب العالي، لكن بصفتي مهندس أنصحك بالبديل الأفضل المتوفر حالياً وهو [اسم منتج مشابه] لأنه يتميز بـ [ذكر ميزة] وسعره [السعر]."
   - لا تقل أبداً "لا يوجد" وتسكت. دائماً اقترح البديل من نفس الفئة (مثلاً: إذا نفدت بطارية 150، اقترح 200).

الروابط: استخدم دائماً الصيغة ${window.location.origin}/#product-[ID]

بيانات المخزون الحية من السحابة:
${context}`,
          temperature: 0.3,
        }
      });
      
      return response.text?.trim() || "أهلاً بك. أنا مهندس المبيعات في حيفان، كيف يمكنني مساعدتك في تصميم منظومتك اليوم؟";
    } catch (e) {
      return "أهلاً بك يا غالي. أنا هنا لمساعدتك في اختيار أفضل ألواح جينكو وبطاريات توبو بأسعار منافسة. ما هي الأجهزة التي تود تشغيلها؟";
    }
  }
}

export const geminiService = new GeminiService();
